import re
import unicodedata
from typing import Dict

from osprey.engine.executor.execution_context import ExecutionContext
from osprey.engine.stdlib.udfs.string import StringArguments
from osprey.engine.udf.base import UDFBase

# a big collection of lookalike characters that we have found useful (and have been used in the wild during e.g. raids)
lookalikes = {
    'a': [
        'a',
        'A',
        'ğ°',
        'ğª',
        'Ğ°',
        'É‘',
        'Î±',
        'ğ›‚',
        'âº',
        'ğœ¶',
        'ğ›¼',
        'á—…',
        'ğš¨',
        'Ğ',
        'Î‘',
        'ğ›¢',
        'ğ–',
        'ğœœ',
        'ğ–½€',
        'ğ',
        'áª',
        'ê“®',
        'ğŠ ',
        'Ğ°',
        'áº¡',
        'Ä…',
        'Ã¤',
        'Ã ',
        'Ã¡',
        'Ä…',
        '4',
        '@',
        '^',
        'Î±',
        'Ğ°',
        'â²€',
        'â²',
        'á—©',
        'x',
        '*',
        '_',
        '-',
    ],
    'b': [
        'b',
        'B',
        'Æ„',
        'Ğ¬',
        'á',
        'á–¯',
        'á‘²',
        'ğš©',
        'ê“',
        'Î’',
        'Ğ’',
        'ğœ',
        'ğ›£',
        'ğ—',
        'ğŠ‚',
        'ğŒ',
        'ğ‘',
        'ê´',
        'á´',
        'á—·',
        'ğŠ¡',
        '8',
        'Î²',
        'Ï',
    ],
    'c': [
        'c',
        'C',
        'Ñ',
        'á´„',
        'â²¥',
        'ğ½',
        'ê®¯',
        'Ï²',
        'ğŒ‚',
        'ê“š',
        'áŸ',
        'ğ”œ',
        'Ğ¡',
        'â²¤',
        'ğ•',
        'ğŸŒ',
        'ğ‘£²',
        'ğ‘£©',
        'Ï¹',
        'ğŠ¢',
        'Ñ',
        'Æˆ',
        'Ä‹',
        '(',
        '<',
        'Â©',
        'k',
        '[',
        '{',
        'á‘•',
    ],
    'd': [
        'd',
        'D',
        'Ô',
        'á§',
        'á‘¯',
        'ê“’',
        'á ',
        'á—ª',
        'ê““',
        'á—',
        'Ô',
        'É—',
    ],
    'e': [
        'e',
        'E',
        'â„®',
        'ê¬²',
        'Ğµ',
        'Ò½',
        'ğ›¦',
        'ğš¬',
        'ğœ ',
        'Î•',
        'Ğ•',
        'ğŠ†',
        'ğš',
        'ğ”',
        'á¬',
        'ê“°',
        'ğ‘¢®',
        'â´¹',
        'ğ‘¢¦',
        'â‹¿',
        'Ğµ',
        'áº¹',
        'Ä—',
        'Ã©',
        'Ã¨',
        '3',
        'â‚¬',
        'Ñ”',
        'âˆ‘',
        'Îµ',
        'Ïµ',
        'x',
        '*',
        '_',
        '-',
    ],
    'f': [
        'f',
        'F',
        'Ö„',
        'ê¬µ',
        'ê™',
        'áº',
        'Å¿',
        'ğˆ“',
        'ğ‘¢¢',
        'ê˜',
        'Ïœ',
        'ğŠ‡',
        'ê“',
        'ğ”¥',
        'ğ‘£‚',
        'ğŸŠ',
        'á–´',
        'ğŠ¥',
    ],
    'g': [
        'g',
        'G',
        'É¡',
        'Ö',
        'á¶ƒ',
        'Æ',
        'á€',
        'ÔŒ',
        'á³',
        'ê“–',
        'Ä¡',
        'q',
        '9',
        '6',
        '&',
        'Â©',
    ],
    'h': [
        'h',
        'H',
        'á‚',
        'Õ°',
        'Ò»',
        'ğš®',
        'ğ›¨',
        'â²',
        'ğ‹',
        'ğœ¢',
        'Î—',
        'ğ–',
        'ğœ',
        'Ğ',
        'ê“§',
        'á»',
        'á•¼',
        'Ò»',
        '#',
    ],
    'i': [
        'i',
        'I',
        'ğ²',
        'ê™‡',
        'Ó',
        'ğš¤',
        'Ñ–',
        'Ë›',
        'á¥',
        'ğ‘£ƒ',
        'É©',
        'Éª',
        'ğ›Š',
        'Ä±',
        'ğœ¾',
        'â³',
        'ğœ„',
        'ê­µ',
        'ğ¸',
        'Î¹',
        'Íº',
        'ğš°',
        'ğ˜­',
        'Ğ†',
        'ğ¥',
        'ïº',
        'ïº',
        'ğ”©',
        'ğŠŠ',
        'â²’',
        'ğŒ‰',
        'â„“',
        'ğœ¤',
        'Æ–',
        'ğ˜',
        'Î™',
        'ğš•',
        'ğŸ',
        'âˆ£',
        'Ø§',
        'ğ—…',
        '1',
        'ğ“',
        'ğŒ ',
        'ğ¸€',
        'ğº€',
        '×€',
        'Ç€',
        'Ó€',
        'á›',
        'ğŸ­',
        'ßŠ',
        'ï½Œ',
        'ğ›ª',
        'âµ',
        'ğ',
        'ğ•',
        'ğŸ£',
        '×•',
        'ğ£‡',
        'ğ™¡',
        'ğŸ™',
        'ğ‘™',
        '×Ÿ',
        'Ù¡',
        'ğ’',
        'ğ–‘',
        'ï¿¨',
        'ğŸ¯±',
        'l',
        'Û±',
        'ê“²',
        'ğ–¼¨',
        'ğŸ·',
        'ğ“µ',
        '|',
        'â…¼',
        'â½',
        'ğ—¹',
        'Ñ–',
        'Ã­',
        'Ã¯',
        '1',
        '!',
        'l',
        'x',
        '|',
        'âˆ«',
        '*',
        '_',
        '-',
    ],
    'j': [
        'j',
        'J',
        'Ï³',
        'Ñ˜',
        'Ğˆ',
        'á«',
        'á’',
        'ê²',
        'ê“™',
        'Í¿',
        'Ñ˜',
        'Ê',
    ],
    'k': [
        'k',
        'K',
        'ğš±',
        'ğœ¥',
        'ğ›«',
        'ğŸ',
        'â²”',
        'á›•',
        'ê“—',
        'Îš',
        'Ğš',
        'ğ™',
        'á¦',
        'ğ”˜',
        'Îº',
        'c',
        '<',
        '[',
        '{',
        'Â©',
    ],
    'l': [
        'l',
        'L',
        'ğš°',
        'Ğ†',
        'ğ–¨',
        'ïº',
        'ïº',
        'â„',
        'â„‘',
        'ğŠŠ',
        'â²’',
        'ğŒ‰',
        'ğœ¤',
        'Æ–',
        'ğ˜',
        'Î™',
        'ğŸ',
        'âˆ£',
        'Ø§',
        'ï¼©',
        'ğ•€',
        '1',
        'ğ™„',
        'ğŒ ',
        'ğ¼',
        'ğ¸€',
        'ğº€',
        '×€',
        'ğ‘°',
        'Ç€',
        'Ó€',
        'á›',
        'ğŸ­',
        'ğ•´',
        'I',
        'ßŠ',
        'ğ›ª',
        'âµ',
        'ğ',
        'ğŸ£',
        '×•',
        'ğ£‡',
        'ğ“˜',
        'ğ—œ',
        'ğŸ™',
        '×Ÿ',
        'â… ',
        'ğ˜',
        'Ù¡',
        'ï¿¨',
        'ğŸ¯±',
        'ğˆ',
        'Û±',
        'ê“²',
        'ğ–¼¨',
        'ğ™¸',
        'ğŸ·',
        '|',
        'â½',
        'ğ–¼–',
        'ğ‘¢£',
        'â³',
        'á',
        'ğ”¦',
        'ê“¡',
        'ğ›',
        'á’ª',
        'ğˆª',
        'ğ‘¢²',
        'Ó',
        'á¸·',
        'i',
        '1',
        '!',
        'x',
        '|',
        'âˆ«',
        '*',
        '_',
        '-',
    ],
    'm': [
        'm',
        'M',
        'ğ‘œ€',
        'ğ‘££',
        'rn',
        'ğ›­',
        'ğš³',
        'ğœ§',
        'ğŒ‘',
        'á›–',
        'ğ¡',
        'â²˜',
        'Îœ',
        'Ğœ',
        'ğ›',
        'ê“Ÿ',
        'ğŠ°',
        'á—°',
        'á·',
        'Ïº',
        'â²™',
    ],
    'n': [
        'n',
        'N',
        'Õ¸',
        'Õ¼',
        'ê“ ',
        'ğ›®',
        'ğš´',
        'ğœ¨',
        'ğ”“',
        'ğ¢',
        'â²š',
        'ğœ',
        'Î',
        'Õ¸',
        'â²›',
    ],
    'o': [
        'o',
        'O',
        'à°‚',
        'à²‚',
        'à´‚',
        'à¶‚',
        'Ö…',
        'ğ‘£—',
        'á´',
        'á´‘',
        'ğ¹¤',
        'ğ“ª',
        'ğ‘£ˆ',
        'á€',
        'â²Ÿ',
        'ğ›',
        'à´ ',
        'ğ›”',
        'ï®¦',
        'ï®§',
        'ğˆ',
        'ï®¨',
        'ï®©',
        'ï®ª',
        'ï®«',
        'ï®¬',
        'ï®­',
        'ğº„',
        'ğ„',
        'ğ¸',
        'ğ¼',
        'ê¬½',
        'Ğ¾',
        'Ú¾',
        'Î¿',
        'á€',
        'Û',
        'Ïƒ',
        'Ù‡',
        'à¹',
        'à»',
        'ğ¬',
        'ğ¸¤',
        'Û•',
        '×¡',
        'ğœ',
        'Ù¥',
        'à¥¦',
        'à©¦',
        'à«¦',
        'à¯¦',
        'à±¦',
        'à³¦',
        'àµ¦',
        'ï»©',
        'ï»ª',
        'ï»«',
        'ï»¬',
        'ğœŠ',
        'ğ¾',
        'Ûµ',
        'ğ‚',
        'áƒ¿',
        'ß€',
        'ğ›°',
        'ğ‘£ ',
        'ã€‡',
        'ğŠ’',
        'ğŸ¬',
        'ğœª',
        'á‹',
        'ğ',
        'ğ¤',
        'âµ”',
        'Õ•',
        'ğŸ¢',
        'ğŸ˜',
        'â²',
        'Ğ',
        'ÎŸ',
        'à¬ ',
        'ğŸ',
        'à§¦',
        'à­¦',
        'ğŸ¯°',
        'ğ”–',
        '0',
        'ğ‘“',
        'ğŠ«',
        'ê“³',
        'ğ‘¢µ',
        'ğ„',
        'ğŸ¶',
        'ğš¶',
        'ğ“‚',
        'Ğ¾',
        'Î¿',
        'Ö…',
        'È¯',
        'á»',
        'á»',
        'Æ¡',
        'Ã³',
        'Ã²',
        'Ã¶',
        '0',
        'Î©',
        'Î¸',
        'Î˜',
        'x',
        '*',
        '_',
        '-',
    ],
    'p': [
        'p',
        'P',
        'Ñ€',
        'Ï',
        'ğ› ',
        'ğœš',
        'ğ',
        'â²£',
        'ğ”',
        'ğ›’',
        'ğŸˆ',
        'ğ†',
        'ğœŒ',
        'ğ€',
        'Ï±',
        'â´',
        'ğº',
        'ğ›²',
        'ğ¦',
        'ğœ¬',
        'ğŠ•',
        'ğ ',
        'ê“‘',
        'Ğ ',
        'Î¡',
        'â²¢',
        'á¢',
        'á‘­',
        'ğš¸',
        'Ñ€',
        'Ö„',
    ],
    'q': [
        'q',
        'Q',
        'Õ£',
        'Õ¦',
        'Ô›',
        'âµ•',
        'Õ¦',
    ],
    'r': [
        'r',
        'R',
        'ê®',
        'â²…',
        'á´¦',
        'ê­‡',
        'ê­ˆ',
        'Ğ³',
        'á¡',
        'ğ–¼µ',
        'ê“£',
        'Æ¦',
        'á–‡',
        'ğ’´',
        'á’',
        'ğˆ–',
        'Ğ¯',
    ],
    's': [
        's',
        'S',
        'ğ‘£',
        'ê®ª',
        'êœ±',
        'Ñ•',
        'ğ‘ˆ',
        'Æ½',
        'ê“¢',
        'ğ–¼º',
        'ğ ',
        'Ğ…',
        'ğŠ–',
        'Õ',
        'á•',
        'áš',
        'Ê‚',
        '5',
        '$',
        'z',
        'Â§',
        '2',
        'Å›',
    ],
    't': [
        't',
        'T',
        'ğœ¯',
        'ğŠ—',
        'ğŒ•',
        'ğ©',
        'ğŸ¨',
        'ê“”',
        'ğ–¼Š',
        'ğ£',
        'âŸ™',
        'Ğ¢',
        'á¢',
        'âŠ¤',
        'Î¤',
        'â²¦',
        'ğŠ±',
        'ğ‘¢¼',
        'ğ›µ',
        'ğš»',
        '7',
        '+',
        'â€ ',
        'Ï„',
        'Ñ‚',
        'â²§',
    ],
    'u': [
        'u',
        'U',
        'Ï…',
        'ğ‘£˜',
        'Ê‹',
        'ê­',
        'ğ“¶',
        'ê­’',
        'ğ›–',
        'á´œ',
        'êŸ',
        'ğœ',
        'ğŠ',
        'ğ¾',
        'ğ„',
        'Õ½',
        'áˆ€',
        'â‹ƒ',
        'ğ‘¢¸',
        'âˆª',
        'á‘Œ',
        'Õ',
        'ê“´',
        'ğ“',
        'ğ–½‚',
        'Ï…',
        'Õ½',
        'Ã¼',
        'Ãº',
        'Ã¹',
        'v',
        'Âµ',
        'x',
        '*',
        '_',
        '-',
    ],
    'v': [
        'v',
        'V',
        'â‹',
        '×˜',
        'á´ ',
        'ğ‘£€',
        'ğ›',
        'âˆ¨',
        'ğœˆ',
        'ê®©',
        'Ñµ',
        'ğ‚',
        'ğ¶',
        'ğ‘œ†',
        'ğ¼',
        'Î½',
        'ğ‘¢ ',
        'ğˆ',
        'ğ–¼ˆ',
        'á™',
        'ê›Ÿ',
        'ê“¦',
        'Ù§',
        'ğ”',
        'á¯',
        'Ñ´',
        'Û·',
        'â´¸',
        'Î½',
        'Ñµ',
        'u',
    ],
    'w': [
        'w',
        'W',
        'á´¡',
        'Ñ¡',
        'Õ¡',
        'ê®ƒ',
        'É¯',
        'ğ‘œ',
        'ğ‘œ',
        'Ô',
        'ğ‘œŠ',
        'ê“ª',
        'ğ‘£¯',
        'á³',
        'á”',
        'ğ‘£¦',
        'Ôœ',
        'Ï‰',
    ],
    'x': [
        'x',
        'X',
        'á•',
        'Ñ…',
        'â¤«',
        'â¤¬',
        'á™®',
        'â¨¯',
        'Ã—',
        'á•½',
        'ğœ²',
        'ğ¦',
        'ğŠ',
        'ğ¬',
        'ğŒ—',
        'âµ',
        'ğ”§',
        'Ğ¥',
        'Î§',
        'ê“«',
        'â²¬',
        'á™­',
        'ğŠ´',
        'ğš¾',
        'â•³',
        'ê³',
        'áš·',
        'ğ›¸',
        'ğŒ¢',
        'ğ‘£¬',
        'Ñ…',
        'Ò³',
        'Ã—',
        'Ï‡',
        'â²­',
    ],
    'y': [
        'y',
        'Y',
        'Ñƒ',
        'ğ²',
        'á¶Œ',
        'ğ¬',
        'ğ‘£œ',
        'Ê',
        'ê­š',
        'É£',
        'áƒ§',
        'Ò¯',
        'ğ›¾',
        'Î³',
        'ğ›„',
        'ğœ¸',
        'â„½',
        'á»¿',
        'ğœ°',
        'ğ‘¢¤',
        'ğª',
        'Ï’',
        'ğ–½ƒ',
        'ğ¤',
        'Ğ£',
        'Î¥',
        'â²¨',
        'á©',
        'ğŠ²',
        'ê“¬',
        'Ò®',
        'ğ›¶',
        'ğš¼',
        'á½',
        'Ñƒ',
        'Ã½',
        'Â¥',
        'Î»',
        'Ê',
    ],
    'z': [
        'z',
        'Z',
        'á´¢',
        'ğ‘£„',
        'ê®“',
        'ğš­',
        'áƒ',
        'ğ‘£¥',
        'ğ›§',
        'Î–',
        'ğœ¡',
        'ğ•',
        'ê“œ',
        'ğ›',
        'ğ‹µ',
        'ğ‘¢©',
        'Ê',
        'Å¼',
        '2',
        'â‰¥',
        's',
        'Î¶',
    ],
}


def create_censored_regex(
    token: str,
    include_plural: bool,
    include_substrings: bool,
) -> re.Pattern[str]:
    """
    Create a compiled regex pattern that matches all variations of a token based on character replacement set.

    Args:
        token: The token to create a censored regex for
        include_plural: Will allow for each pattern to be compatible with plurals, i.e. if 'cat' is passed, the pattern will be 'cat[sS$]?'
        include_substrings: Whether substrings of characters are allowed, i.e. if "concatenate" will match "cat" or not
        char_set: The set of lookalike characters you wish to use. Defaults to the provided lookalike charset. Should be string literals for values,
            not regex patterns
    """

    token = token.lower()

    regex = ''

    # if we're not including substrings, start with forcing word boundary at the beginning of the string
    if not include_substrings:
        regex += r'(?:^|\W)'

    # create a capture group for the word
    regex += '(?P<word>'

    # start by looping over each character in the token
    for index, char in enumerate(token):
        char_variations = lookalikes.get(char)
        if char_variations is None:
            char_variations = [char]

        # place each possible character in the pattern
        regex += '['
        for char_variation in char_variations:
            regex += re.escape(char_variation)
        regex += ']'

        # if this isn't the last character in the token, we want to allow for "space" characters that people
        # often use, i.e. 'c#a#t' or 'c_a_t', as well as zero-width unicode characters used to evade filters
        if index < len(token) - 1:
            regex += r'[,.+/|&%#!@_\u200b\u200c\u200d\u200e\u200f\ufeff]*'

    # once we are at the end of the string, add on any possible s character if we are checking for substrings
    if include_plural:
        # start by adding our space characters
        regex += r'[,.+/|&%#!@_\u200b\u200c\u200d\u200e\u200f\ufeff]*'

        # grab the s variations from the charset
        s_variations = lookalikes.get('s', ['s', 'S'])

        # append each of the s variations
        regex += '['
        for s_variation in s_variations:
            regex += re.escape(s_variation)
        regex += ']?'

    # close the word capture group
    regex += ')'

    # follow up with a word boundary if we are not checking substrings
    if not include_substrings:
        regex += r'(?:\W|$)'

    return re.compile(regex)


class CensorCache:
    def __init__(self) -> None:
        self._cache: Dict[tuple[str, bool, bool], re.Pattern[str]] = {}

    def get_censored_regex(self, term: str, plurals: bool, substrings: bool) -> re.Pattern[str]:
        """
        Gets a regex pattern from the regex cache or creates a new one if it is not already in the cache.
        """

        cache_key = term
        cache_key = (term, plurals, substrings)

        if cache_key not in self._cache:
            pattern = create_censored_regex(term, include_plural=plurals, include_substrings=substrings)
            self._cache[cache_key] = pattern

        return self._cache[cache_key]


censor_cache = CensorCache()


class CheckCensoredArguments(StringArguments):
    pattern: str
    """
    The string to create a regex pattern for.
    """

    plurals: bool = False
    """
    Whether to check for plurals of the string as well. I.e. if the input is 'cat', match both 'cat' and 'cats'.

    Default: False
    """

    substrings: bool = False
    """
    Whether to check substrings of the input string. I.e. 'concatenate' would match the pattern created for 'cat'.

    Default: False
    """

    must_be_censored: bool = False
    """
    Whether a string must be censored to return True. For example, 'cat' itself would return false but 'c@t'
    would return true.

    Default: False
    """


class CheckCensored(UDFBase[CheckCensoredArguments, bool]):
    """
    Checks a given string against another string's censored regex.
    """

    def execute(self, execution_context: ExecutionContext, arguments: CheckCensoredArguments) -> bool:
        normalized = unicodedata.normalize('NFKC', arguments.s)

        pattern = censor_cache.get_censored_regex(
            arguments.pattern, plurals=arguments.plurals, substrings=arguments.substrings
        )

        match = pattern.search(normalized)
        if match is None:
            return False

        if arguments.must_be_censored:
            matched_word = match.group('word')
            if matched_word.lower() == arguments.pattern.lower():
                return False

        return True
