import re
import unicodedata
from functools import lru_cache

from osprey.engine.executor.execution_context import ExecutionContext
from osprey.engine.stdlib.udfs.categories import UdfCategories
from osprey.engine.stdlib.udfs.string import StringArguments
from osprey.engine.udf.base import UDFBase

_SEPARATOR_PATTERN = r'[,.+/|&%#!@_\u200b\u200c\u200d\u200e\u200f\ufeff]{0,20}'

_SEPARATOR_CHARS = frozenset(',.+/|&%#!@_\u200b\u200c\u200d\u200e\u200f\ufeff')

_HOMOGLYPH_MAP: dict[str, str] = {
    'Ğ°': 'a',
    'É‘': 'a',
    'Î±': 'a',
    'âº': 'a',
    'Ğ': 'a',
    'Î‘': 'a',
    'áª': 'a',
    'ê“®': 'a',
    'áº¡': 'a',
    'Ä…': 'a',
    'Ã¤': 'a',
    'Ã ': 'a',
    'Ã¡': 'a',
    'â²€': 'a',
    'â²': 'a',
    'á—©': 'a',
    'á—…': 'a',
    'ğ€': 'a',
    'ğš': 'a',
    'ğ‘¨': 'a',
    'ğ’‚': 'a',
    'ğ’œ': 'a',
    'ğ’¶': 'a',
    'ğ“': 'a',
    'ğ“ª': 'a',
    'ğ”„': 'a',
    'ğ”': 'a',
    'ğ”¸': 'a',
    'ğ•’': 'a',
    'ğ•¬': 'a',
    'ğ–†': 'a',
    'ğ– ': 'a',
    'ğ–º': 'a',
    'ğ—”': 'a',
    'ğ—®': 'a',
    'ğ˜ˆ': 'a',
    'ğ˜¢': 'a',
    'ğ˜¼': 'a',
    'ğ™–': 'a',
    'ğ™°': 'a',
    'ğšŠ': 'a',
    'ğš¨': 'a',
    'ğ›‚': 'a',
    'ğ›¢': 'a',
    'ğ›¼': 'a',
    'ğœœ': 'a',
    'ğœ¶': 'a',
    'ğ–': 'a',
    'ğ°': 'a',
    'ğ': 'a',
    'ğª': 'a',
    'ï½': 'a',
    'ï¼¡': 'a',
    'Æ„': 'b',
    'Ğ¬': 'b',
    'á': 'b',
    'á–¯': 'b',
    'á‘²': 'b',
    'ê“': 'b',
    'Î’': 'b',
    'Ğ’': 'b',
    'Î²': 'b',
    'Ï': 'b',
    'ê´': 'b',
    'á´': 'b',
    'á—·': 'b',
    'ğ': 'b',
    'ğ›': 'b',
    'ğ‘©': 'b',
    'ğ’ƒ': 'b',
    'â„¬': 'b',
    'ğ’·': 'b',
    'ğ“‘': 'b',
    'ğ“«': 'b',
    'ğ”…': 'b',
    'ğ”Ÿ': 'b',
    'ğ”¹': 'b',
    'ğ•“': 'b',
    'ğ•­': 'b',
    'ğ–‡': 'b',
    'ğ–¡': 'b',
    'ğ–»': 'b',
    'ğ—•': 'b',
    'ğ—¯': 'b',
    'ğ˜‰': 'b',
    'ğ˜£': 'b',
    'ğ˜½': 'b',
    'ğ™—': 'b',
    'ğ™±': 'b',
    'ğš‹': 'b',
    'ğš©': 'b',
    'ğ›£': 'b',
    'ğœ': 'b',
    'ğ—': 'b',
    'ğ‘': 'b',
    'ï½‚': 'b',
    'ï¼¢': 'b',
    'Ñ': 'c',
    'á´„': 'c',
    'â²¥': 'c',
    'ê®¯': 'c',
    'Ï²': 'c',
    'ê“š': 'c',
    'áŸ': 'c',
    'Ğ¡': 'c',
    'â²¤': 'c',
    'Ï¹': 'c',
    'Æˆ': 'c',
    'Ä‹': 'c',
    'ğŸŒ': 'c',
    'â„‚': 'c',
    'â„­': 'c',
    'ğ‚': 'c',
    'ğœ': 'c',
    'ğ¶': 'c',
    'ğ‘': 'c',
    'ğ‘ª': 'c',
    'ğ’„': 'c',
    'ğ’': 'c',
    'ğ’¸': 'c',
    'ğ“’': 'c',
    'ğ“¬': 'c',
    'ğ” ': 'c',
    'ğ•”': 'c',
    'ğ•®': 'c',
    'ğ–ˆ': 'c',
    'ğ–¢': 'c',
    'ğ–¼': 'c',
    'ğ—–': 'c',
    'ğ—°': 'c',
    'ğ˜Š': 'c',
    'ğ˜¤': 'c',
    'ğ˜¾': 'c',
    'ğ™˜': 'c',
    'ğ™²': 'c',
    'ğšŒ': 'c',
    'ï½ƒ': 'c',
    'ï¼£': 'c',
    'á‘•': 'c',
    'áƒ«': 'd',
    'â……': 'd',
    'â…†': 'd',
    'ğƒ': 'd',
    'ğ': 'd',
    'ğ·': 'd',
    'ğ‘‘': 'd',
    'ğ‘«': 'd',
    'ğ’…': 'd',
    'ğ’Ÿ': 'd',
    'ğ’¹': 'd',
    'ğ““': 'd',
    'ğ“­': 'd',
    'ğ”‡': 'd',
    'ğ”¡': 'd',
    'ğ”»': 'd',
    'ğ••': 'd',
    'ğ•¯': 'd',
    'ğ–‰': 'd',
    'ğ–£': 'd',
    'ğ–½': 'd',
    'ğ——': 'd',
    'ğ—±': 'd',
    'ğ˜‹': 'd',
    'ğ˜¥': 'd',
    'ğ˜¿': 'd',
    'ğ™™': 'd',
    'ğ™³': 'd',
    'ğš': 'd',
    'Ô': 'd',
    'ï½„': 'd',
    'ï¼¤': 'd',
    'Ğµ': 'e',
    'â„¯': 'e',
    'â„°': 'e',
    'â…‡': 'e',
    'â„®': 'e',
    'ğ„': 'e',
    'ğ': 'e',
    'ğ¸': 'e',
    'ğ‘’': 'e',
    'ğ‘¬': 'e',
    'ğ’†': 'e',
    'ğ“”': 'e',
    'ğ“®': 'e',
    'ğ”ˆ': 'e',
    'ğ”¢': 'e',
    'ğ”¼': 'e',
    'ğ•–': 'e',
    'ğ•°': 'e',
    'ğ–Š': 'e',
    'ğ–¤': 'e',
    'ğ–¾': 'e',
    'ğ—˜': 'e',
    'ğ—²': 'e',
    'ğ˜Œ': 'e',
    'ğ˜¦': 'e',
    'ğ™€': 'e',
    'ğ™š': 'e',
    'ğ™´': 'e',
    'ğš': 'e',
    'ğš¬': 'e',
    'ğ›¦': 'e',
    'ğœ ': 'e',
    'ğš': 'e',
    'ğ”': 'e',
    'Ğ•': 'e',
    'Î•': 'e',
    'ï½…': 'e',
    'ï¼¥': 'e',
    'â„±': 'f',
    'ğ…': 'f',
    'ğŸ': 'f',
    'ğ¹': 'f',
    'ğ‘“': 'f',
    'ğ‘­': 'f',
    'ğ’‡': 'f',
    'ğ’»': 'f',
    'ğ“•': 'f',
    'ğ“¯': 'f',
    'ğ”‰': 'f',
    'ğ”£': 'f',
    'ğ”½': 'f',
    'ğ•—': 'f',
    'ğ•±': 'f',
    'ğ–‹': 'f',
    'ğ–¥': 'f',
    'ğ–¿': 'f',
    'ğ—™': 'f',
    'ğ—³': 'f',
    'ğ˜': 'f',
    'ğ˜§': 'f',
    'ğ™': 'f',
    'ğ™›': 'f',
    'ğ™µ': 'f',
    'ğš': 'f',
    'ğŸŠ': 'f',
    'ï½†': 'f',
    'ï¼¦': 'f',
    'â„Š': 'g',
    'ğ†': 'g',
    'ğ ': 'g',
    'ğº': 'g',
    'ğ‘”': 'g',
    'ğ‘®': 'g',
    'ğ’ˆ': 'g',
    'ğ’¢': 'g',
    'ğ“–': 'g',
    'ğ“°': 'g',
    'ğ”Š': 'g',
    'ğ”¤': 'g',
    'ğ”¾': 'g',
    'ğ•˜': 'g',
    'ğ•²': 'g',
    'ğ–Œ': 'g',
    'ğ–¦': 'g',
    'ğ—€': 'g',
    'ğ—š': 'g',
    'ğ—´': 'g',
    'ğ˜': 'g',
    'ğ˜¨': 'g',
    'ğ™‚': 'g',
    'ğ™œ': 'g',
    'ğ™¶': 'g',
    'ğš': 'g',
    'ÔŒ': 'g',
    'Ö': 'g',
    'ï½‡': 'g',
    'ï¼§': 'g',
    'â„‹': 'h',
    'â„Œ': 'h',
    'â„': 'h',
    'â„': 'h',
    'ğ‡': 'h',
    'ğ¡': 'h',
    'ğ»': 'h',
    'ğ‘¯': 'h',
    'ğ’‰': 'h',
    'ğ’½': 'h',
    'ğ“—': 'h',
    'ğ“±': 'h',
    'ğ”¥': 'h',
    'ğ•™': 'h',
    'ğ•³': 'h',
    'ğ–': 'h',
    'ğ–§': 'h',
    'ğ—': 'h',
    'ğ—›': 'h',
    'ğ—µ': 'h',
    'ğ˜': 'h',
    'ğ˜©': 'h',
    'ğ™ƒ': 'h',
    'ğ™': 'h',
    'ğ™·': 'h',
    'ğš‘': 'h',
    'ğš®': 'h',
    'ğ›¨': 'h',
    'ğœ¢': 'h',
    'ğœ': 'h',
    'ğ–': 'h',
    'Î—': 'h',
    'Ğ': 'h',
    'Ò»': 'h',
    'Õ°': 'h',
    'ï½ˆ': 'h',
    'ï¼¨': 'h',
    'Ä±': 'i',
    'â„¹': 'i',
    'â…ˆ': 'i',
    'â³': 'i',
    'Î¹': 'i',
    'Ñ–': 'i',
    'Éª': 'i',
    'ğ¢': 'i',
    'ğ‘–': 'i',
    'ğ’Š': 'i',
    'ğ’¾': 'i',
    'ğ“²': 'i',
    'ğ”¦': 'i',
    'ğ•š': 'i',
    'ğ–': 'i',
    'ğ—‚': 'i',
    'ğ—¶': 'i',
    'ğ˜ª': 'i',
    'ğ™': 'i',
    'ğš’': 'i',
    'ğš¤': 'i',
    'ğ›Š': 'i',
    'ğœ„': 'i',
    'ğœ¾': 'i',
    'ğ¸': 'i',
    'ğ²': 'i',
    'ï½‰': 'i',
    'ï¼©': 'i',
    'Î™': 'i',
    'Ğ†': 'i',
    'â…‰': 'j',
    'ğ‰': 'j',
    'ğ£': 'j',
    'ğ½': 'j',
    'ğ‘—': 'j',
    'ğ‘±': 'j',
    'ğ’‹': 'j',
    'ğ’¥': 'j',
    'ğ’¿': 'j',
    'ğ“™': 'j',
    'ğ“³': 'j',
    'ğ”': 'j',
    'ğ”§': 'j',
    'ğ•': 'j',
    'ğ•›': 'j',
    'ğ•µ': 'j',
    'ğ–': 'j',
    'ğ–©': 'j',
    'ğ—ƒ': 'j',
    'ğ—': 'j',
    'ğ—·': 'j',
    'ğ˜‘': 'j',
    'ğ˜«': 'j',
    'ğ™…': 'j',
    'ğ™Ÿ': 'j',
    'ğ™¹': 'j',
    'ğš“': 'j',
    'Ï³': 'j',
    'Ñ˜': 'j',
    'ï½Š': 'j',
    'ï¼ª': 'j',
    'ğŠ': 'k',
    'ğ¤': 'k',
    'ğ¾': 'k',
    'ğ‘˜': 'k',
    'ğ‘²': 'k',
    'ğ’Œ': 'k',
    'ğ’¦': 'k',
    'ğ“€': 'k',
    'ğ“š': 'k',
    'ğ“´': 'k',
    'ğ”': 'k',
    'ğ”¨': 'k',
    'ğ•‚': 'k',
    'ğ•œ': 'k',
    'ğ•¶': 'k',
    'ğ–': 'k',
    'ğ–ª': 'k',
    'ğ—„': 'k',
    'ğ—': 'k',
    'ğ—¸': 'k',
    'ğ˜’': 'k',
    'ğ˜¬': 'k',
    'ğ™†': 'k',
    'ğ™ ': 'k',
    'ğ™º': 'k',
    'ğš”': 'k',
    'ğš±': 'k',
    'ğ›«': 'k',
    'ğœ¥': 'k',
    'ğŸ': 'k',
    'ğ™': 'k',
    'Îš': 'k',
    'Ğš': 'k',
    'Îº': 'k',
    'ï½‹': 'k',
    'ï¼«': 'k',
    'â„': 'l',
    'â„‘': 'l',
    'â„’': 'l',
    'â„“': 'l',
    'âˆ£': 'l',
    'â½': 'l',
    'ï¿¨': 'l',
    'ğˆ': 'l',
    'ğ‹': 'l',
    'ğ¥': 'l',
    'ğ¼': 'l',
    'ğ¿': 'l',
    'ğ‘™': 'l',
    'ğ‘°': 'l',
    'ğ‘³': 'l',
    'ğ’': 'l',
    'ğ“': 'l',
    'ğ“˜': 'l',
    'ğ“›': 'l',
    'ğ“µ': 'l',
    'ğ”': 'l',
    'ğ”©': 'l',
    'ğ•€': 'l',
    'ğ•ƒ': 'l',
    'ğ•': 'l',
    'ğ•´': 'l',
    'ğ•·': 'l',
    'ğ–‘': 'l',
    'ğ–¨': 'l',
    'ğ–«': 'l',
    'ğ—…': 'l',
    'ğ—œ': 'l',
    'ğ—Ÿ': 'l',
    'ğ—¹': 'l',
    'ğ˜': 'l',
    'ğ˜“': 'l',
    'ğ˜­': 'l',
    'ğ™„': 'l',
    'ğ™‡': 'l',
    'ğ™¡': 'l',
    'ğ™¸': 'l',
    'ğ™»': 'l',
    'ğš•': 'l',
    'ğš°': 'l',
    'ğ›ª': 'l',
    'ğœ¤': 'l',
    'ğ': 'l',
    'ğ˜': 'l',
    'Ó€': 'l',
    'Ó': 'l',
    'Õ¬': 'l',
    'ï½Œ': 'l',
    'ï¼¬': 'l',
    'â„³': 'm',
    'ğŒ': 'm',
    'ğ‘€': 'm',
    'ğ‘´': 'm',
    'ğ“œ': 'm',
    'ğ”': 'm',
    'ğ•„': 'm',
    'ğ•¸': 'm',
    'ğ–¬': 'm',
    'ğ— ': 'm',
    'ğ˜”': 'm',
    'ğ™ˆ': 'm',
    'ğ™¼': 'm',
    'ğš³': 'm',
    'ğ›­': 'm',
    'ğœ§': 'm',
    'ğ¡': 'm',
    'ğ›': 'm',
    'Îœ': 'm',
    'Ğœ': 'm',
    'ï½': 'm',
    'ï¼­': 'm',
    'â„•': 'n',
    'ğ': 'n',
    'ğ§': 'n',
    'ğ‘': 'n',
    'ğ‘›': 'n',
    'ğ‘µ': 'n',
    'ğ’': 'n',
    'ğ’©': 'n',
    'ğ“ƒ': 'n',
    'ğ“': 'n',
    'ğ“·': 'n',
    'ğ”‘': 'n',
    'ğ”«': 'n',
    'ğ•Ÿ': 'n',
    'ğ•¹': 'n',
    'ğ–“': 'n',
    'ğ–­': 'n',
    'ğ—‡': 'n',
    'ğ—¡': 'n',
    'ğ—»': 'n',
    'ğ˜•': 'n',
    'ğ˜¯': 'n',
    'ğ™‰': 'n',
    'ğ™£': 'n',
    'ğ™½': 'n',
    'ğš—': 'n',
    'ğš´': 'n',
    'ğ›®': 'n',
    'ğœ¨': 'n',
    'ğ¢': 'n',
    'ğœ': 'n',
    'Î': 'n',
    'Õ¸': 'n',
    'ï½': 'n',
    'ï¼®': 'n',
    'â„´': 'o',
    'ğ': 'o',
    'ğ¨': 'o',
    'ğ‘‚': 'o',
    'ğ‘œ': 'o',
    'ğ‘¶': 'o',
    'ğ’': 'o',
    'ğ’ª': 'o',
    'ğ“': 'o',
    'ğ“¸': 'o',
    'ğ”’': 'o',
    'ğ”¬': 'o',
    'ğ•†': 'o',
    'ğ• ': 'o',
    'ğ•º': 'o',
    'ğ–”': 'o',
    'ğ–®': 'o',
    'ğ—ˆ': 'o',
    'ğ—¢': 'o',
    'ğ—¼': 'o',
    'ğ˜–': 'o',
    'ğ˜°': 'o',
    'ğ™Š': 'o',
    'ğ™¤': 'o',
    'ğ™¾': 'o',
    'ğš˜': 'o',
    'ğš¶': 'o',
    'ğ›': 'o',
    'ğ›”': 'o',
    'ğ›°': 'o',
    'ğœŠ': 'o',
    'ğœ': 'o',
    'ğœª': 'o',
    'ğ„': 'o',
    'ğˆ': 'o',
    'ğ¤': 'o',
    'ğ¾': 'o',
    'ğ‚': 'o',
    'ğ': 'o',
    'ğ¸': 'o',
    'ğ¼': 'o',
    'Î¿': 'o',
    'Ğ¾': 'o',
    'Ö…': 'o',
    'ÎŸ': 'o',
    'Ğ': 'o',
    'ï½': 'o',
    'ï¼¯': 'o',
    'Î¸': 'o',
    'Î˜': 'o',
    'â„™': 'p',
    'â´': 'p',
    'ğ': 'p',
    'ğ©': 'p',
    'ğ‘ƒ': 'p',
    'ğ‘': 'p',
    'ğ‘·': 'p',
    'ğ’‘': 'p',
    'ğ’«': 'p',
    'ğ“…': 'p',
    'ğ“Ÿ': 'p',
    'ğ“¹': 'p',
    'ğ”“': 'p',
    'ğ”­': 'p',
    'ğ•¡': 'p',
    'ğ•»': 'p',
    'ğ–•': 'p',
    'ğ–¯': 'p',
    'ğ—‰': 'p',
    'ğ—£': 'p',
    'ğ—½': 'p',
    'ğ˜—': 'p',
    'ğ˜±': 'p',
    'ğ™‹': 'p',
    'ğ™¥': 'p',
    'ğ™¿': 'p',
    'ğš™': 'p',
    'ğš¸': 'p',
    'ğ›’': 'p',
    'ğ› ': 'p',
    'ğ›²': 'p',
    'ğœŒ': 'p',
    'ğœš': 'p',
    'ğœ¬': 'p',
    'ğ†': 'p',
    'ğ”': 'p',
    'ğ¦': 'p',
    'ğ€': 'p',
    'ğ': 'p',
    'ğ ': 'p',
    'ğº': 'p',
    'ğŸˆ': 'p',
    'Ï': 'p',
    'Ñ€': 'p',
    'Î¡': 'p',
    'Ğ ': 'p',
    'Õ¢': 'p',
    'ï½': 'p',
    'ï¼°': 'p',
    'Öƒ': 'p',
    'Ö„': 'p',
    'â„š': 'q',
    'ğ': 'q',
    'ğª': 'q',
    'ğ‘„': 'q',
    'ğ‘': 'q',
    'ğ‘¸': 'q',
    'ğ’’': 'q',
    'ğ’¬': 'q',
    'ğ“†': 'q',
    'ğ“ ': 'q',
    'ğ“º': 'q',
    'ğ””': 'q',
    'ğ”®': 'q',
    'ğ•¢': 'q',
    'ğ•¼': 'q',
    'ğ––': 'q',
    'ğ–°': 'q',
    'ğ—Š': 'q',
    'ğ—¤': 'q',
    'ğ—¾': 'q',
    'ğ˜˜': 'q',
    'ğ˜²': 'q',
    'ğ™Œ': 'q',
    'ğ™¦': 'q',
    'ğš€': 'q',
    'ğšš': 'q',
    'Ô›': 'q',
    'Õ£': 'q',
    'ï½‘': 'q',
    'ï¼±': 'q',
    'â„›': 'r',
    'â„œ': 'r',
    'â„': 'r',
    'ğ‘': 'r',
    'ğ«': 'r',
    'ğ‘…': 'r',
    'ğ‘Ÿ': 'r',
    'ğ‘¹': 'r',
    'ğ’“': 'r',
    'ğ“‡': 'r',
    'ğ“¡': 'r',
    'ğ“»': 'r',
    'ğ”¯': 'r',
    'ğ•£': 'r',
    'ğ•½': 'r',
    'ğ–—': 'r',
    'ğ–±': 'r',
    'ğ—‹': 'r',
    'ğ—¥': 'r',
    'ğ—¿': 'r',
    'ğ˜™': 'r',
    'ğ˜³': 'r',
    'ğ™': 'r',
    'ğ™§': 'r',
    'ğš': 'r',
    'ğš›': 'r',
    'ï½’': 'r',
    'ï¼²': 'r',
    'ğ’': 's',
    'ğ¬': 's',
    'ğ‘†': 's',
    'ğ‘ ': 's',
    'ğ‘º': 's',
    'ğ’”': 's',
    'ğ’®': 's',
    'ğ“ˆ': 's',
    'ğ“¢': 's',
    'ğ“¼': 's',
    'ğ”–': 's',
    'ğ”°': 's',
    'ğ•Š': 's',
    'ğ•¤': 's',
    'ğ•¾': 's',
    'ğ–˜': 's',
    'ğ–²': 's',
    'ğ—Œ': 's',
    'ğ—¦': 's',
    'ğ˜€': 's',
    'ğ˜š': 's',
    'ğ˜´': 's',
    'ğ™': 's',
    'ğ™¨': 's',
    'ğš‚': 's',
    'ğšœ': 's',
    'Ñ•': 's',
    'ï½“': 's',
    'ï¼³': 's',
    'âŠ¤': 't',
    'âŸ™': 't',
    'ğ“': 't',
    'ğ­': 't',
    'ğ‘‡': 't',
    'ğ‘¡': 't',
    'ğ‘»': 't',
    'ğ’•': 't',
    'ğ’¯': 't',
    'ğ“‰': 't',
    'ğ“£': 't',
    'ğ“½': 't',
    'ğ”—': 't',
    'ğ”±': 't',
    'ğ•‹': 't',
    'ğ•¥': 't',
    'ğ•¿': 't',
    'ğ–™': 't',
    'ğ–³': 't',
    'ğ—': 't',
    'ğ—§': 't',
    'ğ˜': 't',
    'ğ˜›': 't',
    'ğ˜µ': 't',
    'ğ™': 't',
    'ğ™©': 't',
    'ğšƒ': 't',
    'ğš': 't',
    'ğš»': 't',
    'ğ›µ': 't',
    'ğœ¯': 't',
    'ğ©': 't',
    'ğ£': 't',
    'Ï„': 't',
    'Î¤': 't',
    'Ğ¢': 't',
    'Ñ‚': 't',
    'Õ§': 't',
    'ï½”': 't',
    'ï¼´': 't',
    'âˆª': 'u',
    'â‹ƒ': 'u',
    'ğ”': 'u',
    'ğ®': 'u',
    'ğ‘ˆ': 'u',
    'ğ‘¢': 'u',
    'ğ‘¼': 'u',
    'ğ’–': 'u',
    'ğ’°': 'u',
    'ğ“Š': 'u',
    'ğ“¤': 'u',
    'ğ“¾': 'u',
    'ğ”˜': 'u',
    'ğ”²': 'u',
    'ğ•Œ': 'u',
    'ğ•¦': 'u',
    'ğ–€': 'u',
    'ğ–š': 'u',
    'ğ–´': 'u',
    'ğ—': 'u',
    'ğ—¨': 'u',
    'ğ˜‚': 'u',
    'ğ˜œ': 'u',
    'ğ˜¶': 'u',
    'ğ™': 'u',
    'ğ™ª': 'u',
    'ğš„': 'u',
    'ğš': 'u',
    'ğ›–': 'u',
    'ğœ': 'u',
    'ğŠ': 'u',
    'ğ„': 'u',
    'ğ¾': 'u',
    'Ï…': 'u',
    'Õ½': 'u',
    'ï½•': 'u',
    'ï¼µ': 'u',
    'âˆ¨': 'v',
    'â‹': 'v',
    'ğ•': 'v',
    'ğ¯': 'v',
    'ğ‘‰': 'v',
    'ğ‘£': 'v',
    'ğ‘½': 'v',
    'ğ’—': 'v',
    'ğ’±': 'v',
    'ğ“‹': 'v',
    'ğ“¥': 'v',
    'ğ“¿': 'v',
    'ğ”™': 'v',
    'ğ”³': 'v',
    'ğ•': 'v',
    'ğ•§': 'v',
    'ğ–': 'v',
    'ğ–›': 'v',
    'ğ–µ': 'v',
    'ğ—': 'v',
    'ğ—©': 'v',
    'ğ˜ƒ': 'v',
    'ğ˜': 'v',
    'ğ˜·': 'v',
    'ğ™‘': 'v',
    'ğ™«': 'v',
    'ğš…': 'v',
    'ğšŸ': 'v',
    'ğ›': 'v',
    'ğœˆ': 'v',
    'ğ‚': 'v',
    'ğ¼': 'v',
    'ğ¶': 'v',
    'Î½': 'v',
    'Ñµ': 'v',
    'ï½–': 'v',
    'ï¼¶': 'v',
    'ğ–': 'w',
    'ğ°': 'w',
    'ğ‘Š': 'w',
    'ğ‘¤': 'w',
    'ğ‘¾': 'w',
    'ğ’˜': 'w',
    'ğ’²': 'w',
    'ğ“Œ': 'w',
    'ğ“¦': 'w',
    'ğ”€': 'w',
    'ğ”š': 'w',
    'ğ”´': 'w',
    'ğ•': 'w',
    'ğ•¨': 'w',
    'ğ–‚': 'w',
    'ğ–œ': 'w',
    'ğ–¶': 'w',
    'ğ—': 'w',
    'ğ—ª': 'w',
    'ğ˜„': 'w',
    'ğ˜': 'w',
    'ğ˜¸': 'w',
    'ğ™’': 'w',
    'ğ™¬': 'w',
    'ğš†': 'w',
    'ğš ': 'w',
    'Ï‰': 'w',
    'Ñ¡': 'w',
    'ï½—': 'w',
    'ï¼·': 'w',
    'Ã—': 'x',
    'â•³': 'x',
    'â¤«': 'x',
    'â¤¬': 'x',
    'â¨¯': 'x',
    'ğ—': 'x',
    'ğ±': 'x',
    'ğ‘‹': 'x',
    'ğ‘¥': 'x',
    'ğ‘¿': 'x',
    'ğ’™': 'x',
    'ğ’³': 'x',
    'ğ“': 'x',
    'ğ“§': 'x',
    'ğ”': 'x',
    'ğ”›': 'x',
    'ğ”µ': 'x',
    'ğ•': 'x',
    'ğ•©': 'x',
    'ğ–ƒ': 'x',
    'ğ–': 'x',
    'ğ–·': 'x',
    'ğ—‘': 'x',
    'ğ—«': 'x',
    'ğ˜…': 'x',
    'ğ˜Ÿ': 'x',
    'ğ˜¹': 'x',
    'ğ™“': 'x',
    'ğ™­': 'x',
    'ğš‡': 'x',
    'ğš¡': 'x',
    'ğš¾': 'x',
    'ğ›¸': 'x',
    'ğœ²': 'x',
    'ğ¬': 'x',
    'ğ¦': 'x',
    'Ï‡': 'x',
    'Ñ…': 'x',
    'Î§': 'x',
    'Ğ¥': 'x',
    'ï½˜': 'x',
    'ï¼¸': 'x',
    'â„½': 'y',
    'ğ˜': 'y',
    'ğ²': 'y',
    'ğ‘Œ': 'y',
    'ğ‘¦': 'y',
    'ğ’€': 'y',
    'ğ’š': 'y',
    'ğ’´': 'y',
    'ğ“': 'y',
    'ğ“¨': 'y',
    'ğ”‚': 'y',
    'ğ”œ': 'y',
    'ğ”¶': 'y',
    'ğ•': 'y',
    'ğ•ª': 'y',
    'ğ–„': 'y',
    'ğ–': 'y',
    'ğ–¸': 'y',
    'ğ—’': 'y',
    'ğ—¬': 'y',
    'ğ˜†': 'y',
    'ğ˜ ': 'y',
    'ğ˜º': 'y',
    'ğ™”': 'y',
    'ğ™®': 'y',
    'ğšˆ': 'y',
    'ğš¢': 'y',
    'ğš¼': 'y',
    'ğ›„': 'y',
    'ğ›¶': 'y',
    'ğ›¾': 'y',
    'ğœ°': 'y',
    'ğœ¸': 'y',
    'ğª': 'y',
    'ğ²': 'y',
    'ğ¤': 'y',
    'ğ¬': 'y',
    'Î³': 'y',
    'Ñƒ': 'y',
    'Î¥': 'y',
    'Ğ£': 'y',
    'Ã½': 'y',
    'ï½™': 'y',
    'ï¼¹': 'y',
    'â„¤': 'z',
    'â„¨': 'z',
    'ğ™': 'z',
    'ğ³': 'z',
    'ğ‘': 'z',
    'ğ‘§': 'z',
    'ğ’': 'z',
    'ğ’›': 'z',
    'ğ’µ': 'z',
    'ğ“': 'z',
    'ğ“©': 'z',
    'ğ”ƒ': 'z',
    'ğ”·': 'z',
    'ğ•«': 'z',
    'ğ–…': 'z',
    'ğ–Ÿ': 'z',
    'ğ–¹': 'z',
    'ğ—“': 'z',
    'ğ—­': 'z',
    'ğ˜‡': 'z',
    'ğ˜¡': 'z',
    'ğ˜»': 'z',
    'ğ™•': 'z',
    'ğ™¯': 'z',
    'ğš‰': 'z',
    'ğš£': 'z',
    'ğš­': 'z',
    'ğ›§': 'z',
    'ğœ¡': 'z',
    'ğ›': 'z',
    'ğ•': 'z',
    'Î–': 'z',
    'Ğ—': 'z',
    'á´¢': 'z',
    'ê®“': 'z',
    'ï½š': 'z',
    'ï¼º': 'z',
}

_LEET_CHARS: dict[str, list[str]] = {
    'a': ['@', '4', '^'],
    'b': ['8'],
    'c': ['(', '<', 'Â©'],
    'e': ['3', 'â‚¬'],
    'g': ['9', '6'],
    'i': ['1', '!', '|'],
    'l': ['1', '!', '|'],
    'o': ['0'],
    's': ['$', '5'],
    't': ['+', '7'],
    'y': ['Â¥'],
    'z': ['2'],
}

_HOMOGLYPH_TABLE = str.maketrans(_HOMOGLYPH_MAP)


def _normalize_for_match(s: str) -> str:
    """
    Normalize the string with unicodedata then translte any of the homoglyphs we have in our table above
    """
    s = unicodedata.normalize('NFKC', s)
    s = s.translate(_HOMOGLYPH_TABLE)
    return s.lower()


@lru_cache(maxsize=10_000)
def _build_pattern(token: str, include_plural: bool, include_substrings: bool) -> re.Pattern[str]:
    regex = ''

    # start off by adding a word boundary check if we dont want substrings
    if not include_substrings:
        regex += r'(?:^|\W)'

    regex += '(?P<word>'

    # add all of the leet characters to the regex
    for index, char in enumerate(token):
        char_class = [char]
        if char in _LEET_CHARS:
            char_class.extend(_LEET_CHARS[char])

        regex += '[' + ''.join(re.escape(c) for c in char_class) + ']'

        if index < len(token) - 1:
            regex += _SEPARATOR_PATTERN

    # optionally allow for plurals
    if include_plural:
        regex += _SEPARATOR_PATTERN
        regex += 's$5?'

    regex += ')'

    # end in a word boundary if we dont want substrings
    if not include_substrings:
        regex += r'(?:\W|$)'

    return re.compile(regex, re.IGNORECASE)


def _strip_separators(s: str) -> str:
    return ''.join(c for c in s if c not in _SEPARATOR_CHARS)


class StringCheckCensoredArguments(StringArguments):
    pattern: str
    """
    The string to create a regex pattern for.
    """

    plurals: bool = False
    """
    Whether to check for plurals of the string as well. I.e. if the input is 'cat', match both 'cat' and 'cats'.

    Default: False
    """

    substrings: bool = False
    """
    Whether to check substrings of the input string. I.e. 'concatenate' would match the pattern created for 'cat'.

    Default: False
    """

    must_be_censored: bool = False
    """
    Whether a string must be censored to return True. For example, 'cat' itself would return false but 'c@t'
    would return true.

    Default: False
    """


class StringCheckCensored(UDFBase[StringCheckCensoredArguments, bool]):
    """
    Checks a given string, check against another string's censored regex.
    """

    category = UdfCategories.STRING

    def execute(self, execution_context: ExecutionContext, arguments: StringCheckCensoredArguments) -> bool:
        normalized_token = _normalize_for_match(arguments.s)

        pattern_lower = arguments.pattern.lower()
        regex = _build_pattern(pattern_lower, arguments.plurals, arguments.substrings)

        match = regex.search(normalized_token)
        if match is None:
            return False

        if arguments.must_be_censored:
            matched_word = match.group('word')
            matched_stripped = _strip_separators(matched_word).lower()
            if matched_stripped == pattern_lower:
                return False

        return True
